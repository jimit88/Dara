<?php 
$_helper    = $this->helper('Magento\Catalog\Helper\Output');
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$category = $objectManager->get('Magento\Framework\Registry')->registry('current_category');
$childcategories = $category->getChildrenCategories();
/*echo '<pre>';
var_dump($category->debug());

echo 'level:-'.$category->getlevel();
echo '</pre>';
display_mode-BUYERSPICKS*/

?>
<?php if($category->getData('display_mode') == 'BUYERSPICKS'){ ?>
<div class="buyerspicks">

	<div class="category-banner-area">
	<?php
    $_imgHtml   = '';
    if ($_imgUrl = $category->getImageUrl()) {
        $_imgHtml = '<div class="category-image"><img src="' . $_imgUrl . '" alt="' . $block->escapeHtml($category->getName()) . '" title="' . $block->escapeHtml($category->getName()) . '" class="image" /></div>';
        $_imgHtml = $_helper->categoryAttribute($category, $_imgHtml, 'image');
        /* @escapeNotVerified */ echo $_imgHtml;
    }	
	?>
    
    
<?php if ($_description = $block->getCurrentCategory()->getDescription()): ?>
    <div class="category-description">
        <?php /* @escapeNotVerified */ echo $this->helper('Magento\Catalog\Helper\Output')->categoryAttribute($block->getCurrentCategory(), $_description, 'description') ?>
        <div class="category-banner-btn"><a href="#"><span class="cta-btn-text">Shop All <?php echo $block->escapeHtml($category->getName());?> </span> <span class="cta-btn-icon">&nbsp;</span></a></div>
    </div>
<?php endif; ?>
</div>

<?php echo $block->getLayout()->createBlock('Magento\Cms\Block\Block')->setBlockId('buyerpicks_main_content')->toHtml();?>

		<?php if($category->getData('contentv1')){ ?>
        <div class="contentv1">
       	 	<?php echo $category->getData('contentv1'); ?>
        </div>
        <?php } ?>

		<?php if($category->getData('contentv2')){ ?>
        <div class="contentv2">
       		<?php echo $category->getData('contentv2'); ?>
        </div>
        <?php } ?>

		<?php if($category->getData('contentv3')){ ?>
        <div class="contentv3">
        	<?php echo $category->getData('contentv3'); ?>
        </div>
        <?php } ?>
        
        <ul class="all-buyers-pic">
            <?php 
			$i=2; $childcnt= count($childcategories);
			foreach($childcategories as $subcat){
			
			if ($subcat->getIsActive()) {
            $_category = $objectManager->create('Magento\Catalog\Model\Category')->load($subcat->getId());
            $_outputhelper = $this->helper('Magento\Catalog\Helper\Output');
            $subcaturl = $subcat->getUrl();

            $_imgHtml = '';
            if ($_imgUrl = $_category->getImageUrl()) {

                $_imgHtml = '<img src="' . $_imgUrl . '" />';
                $_imgHtml = $_outputhelper->categoryAttribute($_category, $_imgHtml, 'image');

                /* @escapeNotVerified */
               // echo '<li style="width:500px; float:left;"><a href="' . $subcaturl . '" class="block-promo" title="' . $subcat->getName() . '">' . $_imgHtml . '<span style="background-color: rgba(255,255,255,0.9)" class="content bg-white"><strong>'. $subcat->getName().'</strong><br><br><span class="action more button">Shop Now</span></span></a></li>';
			   ?>
               <li class="buy-pick-child-category-list <?php if($i%2==0){ echo "odd"; }else{ echo "even";} ?>" style="display:none;">
               <div class="lf-row">
               <div class="lf-rgt-text-img-area">
  	             <div class="lf-text-img"><?php echo $_imgHtml; ?></div>
                 
                 <div class="lf-conent-box">
<div class="lf-conent-text">
                 <h2><?php echo $_category->getName(); ?></h2>
                 <?php echo $_category->getDescription(); ?>
                 <div class="hp-siws-banner-btn-area"><div class="hp-siws-banner-btn"><a href="<?php echo $subcaturl; ?>"><span class="cta-btn-text">Read More</span> <span class="cta-btn-icon">&nbsp;</span></a></div></div>
                 
                 </div></div>
                 
                 </div>
                 </div>
               </li>               
               <?php
			   $i++;
			   
            }
        }
		
			}
			?>
        </ul>
        <div class=" " id="loadMore" style="display:none;"><span>view more</span></div>
        
<script type="text/javascript">
require(['jquery', 'jquery/ui'], function($){
$( document ).ready(function() {  
$('#loadMore').show();
	size_li = $("ul.all-buyers-pic li").size();
    x=6;
    $('ul.all-buyers-pic li:lt('+x+')').show();
    $('#loadMore').click(function () {
        x= (x+5 <= size_li) ? x+5 : size_li;
        $('ul.all-buyers-pic li:lt('+x+')').show();
         $('#showLess').show();
        if(x == size_li){
            $('#loadMore').hide();
        }
    });
    $('#showLess').click(function () {
        x=(x-5<0) ? 6 : x-5;
        $('ul.all-buyers-pic li').not(':lt('+x+')').hide();
        $('#loadMore').show();
         $('#showLess').show();
        if(x == 6){
            $('#showLess').hide();
        }
    });
	
	
});
});
</script>

</div>
<?php 
////////////////// end BUYERSPICKS

}elseif($category->getData('display_mode') == 'BUYERSPICKSCOLLECTION'){ ?>

<?php if($category->getData('category_content1')){ ?>
        <div class="category_content1">
       	 	<?php  echo $category->getData('category_content1'); ?>
        
        </div>
        
        <?php } ?>
        <?php if($category->getData('contentv1')){ ?>
        
        <div class="contentv1">
       	 	<?php echo $category->getData('contentv1'); ?>
        </div>
        <?php } ?>
        <?php echo $block->getProductListHtml() ?>
        <?php /*
		
		if($category->getData('category_content2')){ ?>
        <div class="category_content1">
       	 	<?php  echo $category->getData('category_content1'); ?>
        </div>
        <?php } */


////////////////// end BUYERSPICKSCOLLECTION

}else{

////////////////// start default view

 if (!$block->isContentMode() || $block->isMixedMode()): ?>
	<?php if(count($childcategories)>0 && $category->getlevel() == 2): ?>
    <?php // parent category - landing page ?>
    
	
	<div class="category-banner-area">
	<?php
    $_imgHtml   = '';
    if ($_imgUrl = $category->getImageUrl()) {
        $_imgHtml = '<div class="category-image"><img src="' . $_imgUrl . '" alt="' . $block->escapeHtml($category->getName()) . '" title="' . $block->escapeHtml($category->getName()) . '" class="image" /></div>';
        $_imgHtml = $_helper->categoryAttribute($category, $_imgHtml, 'image');
        /* @escapeNotVerified */ echo $_imgHtml;
    }	
	?>
    
    
<?php if ($_description = $block->getCurrentCategory()->getDescription()): ?>
    <div class="category-description">
        <?php /* @escapeNotVerified */ echo $this->helper('Magento\Catalog\Helper\Output')->categoryAttribute($block->getCurrentCategory(), $_description, 'description') ?>        
		<?php if($category->getData('contentv2')){ ?>
        <div class="category-banner-btn"><?php  echo $category->getData('contentv2'); ?></div>
        <?php } ?>

    </div>
<?php endif; ?>
</div>

		<?php if($category->getData('category_content1')){ ?>
        <div class="category_content1">
       	 	<?php  echo $category->getData('category_content1'); ?>
        </div>
        <?php } ?>

		<?php if($category->getData('category_content2')){ ?>
        <div class="category_content2">
       		<?php  echo $category->getData('category_content2'); ?>
        </div>
        <?php } ?>

		<?php if($category->getData('category_content3')){ ?>
        <div class="category_content2">
        	<?php  echo $category->getData('category_content3'); ?>
        </div>
        <?php } ?>
        
        
    <div class="new-arrivals-section">
    	<div class="nr-heading-area">
    		<div class="nr-sub-title">New Arrivals</div>
            <div class="nr-rgt-btn-link">
                <a href="javascrip:void(0);">
                   <?php /* <span class="na-full-link">Shop All New <?php $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
                      $current_category = $objectManager->get('Magento\Framework\Registry')->registry('current_category');
                      $parent_category = $current_category->getParentCategory();
                      echo $current_category->getName();
                    ?> Arrivals
                    </span>
                    <span class="na-mobile-link">shop new arrivals</span> */?>shop new arrivals
                 </a>
             </div>
        </div>  
        <div class="block widget block-new-products grid">
            <div class="block-title">.
                <strong role="heading" aria-level="2">New Products</strong>
            </div>
                
  <div class="block-content">
    <!-- new_products_content_widget_grid-->
    <div class="products-grid grid">
      <ol class="product-items widget-new-grid">
    <?php  
	$cnt = count($childcategories);
	
	$i=1;
	foreach($childcategories as $subcategory){

		if($cnt == $i){
			/*echo '<pre>';
			var_dump($subcategory->debug());
			echo $subcategory->getName();
			echo '</pre>';
			echo 'category id:- '.*/
			$categoryId = $subcategory->getEntityId();
			//$getProudctcollection = $block->getCategoryProducts($categoryId);
			
			$objectManager =  \Magento\Framework\App\ObjectManager::getInstance();        
			 
			$appState = $objectManager->get('\Magento\Framework\App\State');
			 
			$categoryFactory = $objectManager->get('\Magento\Catalog\Model\CategoryFactory');
			$categoryHelper = $objectManager->get('\Magento\Catalog\Helper\Category');
			$categoryRepository = $objectManager->get('\Magento\Catalog\Model\CategoryRepository');
			 
			$categoryId = $subcategory->getEntityId(); // YOUR CATEGORY ID
			$category = $categoryFactory->create()->load($categoryId);
			 
			$categoryProducts = $category->getProductCollection()
										 ->addAttributeToSelect('*');
			$categoryProducts = $categoryProducts->addAttributeToSort('position', 'ASC');
			//->addAttributeToSort('name', 'ASC')
			$categoryProducts->setPageSize(3);
			
			$priceHelper = $objectManager->create('Magento\Framework\Pricing\Helper\Data');
										 
			foreach ($categoryProducts as $product) {
				//print_r($product->getData());
				// printing category name and url
				//echo $product->getName() . ' - ' . $product->getProductUrl() . '<br />';
				/*
				
echo "<a href=".$product->getProductUrl()."><img src=".$block->getUrl('pub/media/catalog').'product'.$product->getSmallImage()." />".$product->getName().'</a>';
echo '<br>';
echo $priceHelper->currency($product->getPrice(), true, false);
*/
//$min_price = array();


$options = array();
$color = array();
$myprice = array();
$min_price = 111111111111;
$max_price = 0;
if($product->getTypeId() == 'grouped' ){
//echo '<pre>';
	$_associated_products = $product->getTypeInstance(true)->getAssociatedProducts($product);
    foreach( $_associated_products as $_associated_product ) {
		
		//$min_price[] = $_associated_product->getPrice();
		if($min_price > $_associated_product->getPrice()){
		$min_price = $_associated_product->getPrice();
		} 
		
		if($max_price < $_associated_product->getPrice()){
		$max_price = $_associated_product->getPrice();
		}
		
    }
	
}
?>

<?php 
if($product->getTypeId() == 'configurable' ){
$repository = $objectManager->create('Magento\Catalog\Model\ProductRepository');
$data = $product->getTypeInstance()->getConfigurableOptions($product);


foreach($data as $attr){
  foreach($attr as $p){
  
  /*echo '<pre>';
  var_dump($p);
    echo '</pre>';*/
	$options[$p['sku']][$p['attribute_code']] = $p['option_title']."_".$p['default_title']."=swtchid=".$p['value_index'];
  }
}

foreach($options as $sku =>$d){
  $pr = $repository->get($sku); 
  foreach($d as $k => $v){ 
	
	if($k == 'color'){ 
	$color[] = $v; 
	}
	
	}
  //echo ' : '.$pr->getPrice()."\n";
	if($min_price > $pr->getPrice()){
		$min_price = $pr->getPrice();
	}
}
 }
?>

        <li class="product-item">
        <?php if($product->getData('product_flag')){
		//echo $product->getData('product_flag');
		$pro_flag = $product->getResource()->getAttribute('product_flag')->getFrontend()->getValue($product);
		$categories = ''; $twoflag = '';
		$cats = explode(",", $pro_flag);
		$i=1;
		foreach($cats as $cat) {
			$cat = trim($cat);
			$categories .= "<span class='flag-".$i."'><img src=".$block->getViewFileUrl('images/'.$cat.'.png').">" . "</span>\n";
			$i++;
		}
		echo $categories;

		} ?>
          <div class="product-item-info"> <a href="<?php echo $product->getProductUrl(); ?>" class="product-item-photo"> <span class="product-image-container" style="width:348px;"> <span class="product-image-wrapper" style="padding-bottom: 85.985748218527%;"> <img class="product-image-photo" src="<?php 
		  echo $this->helper('Magento\Catalog\Helper\Image')->init($product, 'product_page_image_large')->keepAspectRatio(TRUE)->keepFrame(TRUE)->resize(842, 724)->getUrl(); 
		  //echo $block->getUrl('pub/media/catalog').'product'.$product->getSmallImage(); ?>" alt="<?php echo $product->getName(); ?>" width="421" height="362"></span> </span> </a>
            <div class="product-item-details"> <strong class="product-item-name"> <a title="Alma Chair New" href="<?php echo $product->getProductUrl(); ?>" class="product-item-link"><?php echo $product->getName(); ?></a> </strong> <?php 
			  if($min_price != 111111111111){
			  		if($product->getTypeId() == 'grouped' ){
						echo "<div class='price-box price-final_price'><span class='mini-price'>".str_replace('.00', '',$priceHelper->currency($min_price, true, false))."</span>"; 
						if($min_price != $max_price){
						echo "<span class='max-price'> - ".str_replace('.00', '',$priceHelper->currency($max_price, true, false))."</span>"; 
						}
						echo "</div>";
					}else{
						//echo "<span class='mini-price'>Starting at</span>".$priceHelper->currency($min_price, true, false); 
						?>
                        <div class="price-box price-final_price" data-role="priceBox" data-product-id="3">
                          <div class="price-box" itemprop="offers" itemscope="" itemtype="http://schema.org/Offer">
                            <p class="minimal-price"> <span class="price-label">Starting at</span> <span class="price-container tax weee" style=""> <span data-price-amount="1" data-price-type="" class="price-wrapper "> <span class="price"><?php echo str_replace('.00', '',$priceHelper->currency($min_price, true, false)); ?></span> </span> </span> </p>
                          </div>
                        </div>

                        <?php 
					}
					
			  }else{
			  ?>
			  
              <div class="price-box price-final_price" data-role="priceBox" data-product-id="4"> <span class="price-container price-final_price tax weee" style=""> <span id="product-price-4" data-price-amount="2495" data-price-type="finalPrice" class="price-wrapper "> <span class="price"><?php echo str_replace('.00', '',$priceHelper->currency($product->getPrice(), true, false)); ?></span> </span> </span> </div>
              <?php 
			  }
			  ?>   
              <div class="product-item-actions">
                
                
              </div>
            <?php 
			if($product->getRelatedProducts()){
			echo '<div class="available_coption">custom options available</div>';
			}
			?>  
            
            
			<?php if($product->getTypeId() == 'configurable' ){ ?>
            <div class="available_color"></div>
            <div class='custom-option'>
            <div class="swatch-attribute color" attribute-code="color" attribute-id="#">
            <div class="swatch-attribute-options clearfix">
            <?php 
			$color = array_unique($color); 
			  
			foreach($color as $_color){ 
			$arr = explode('_', $_color);
			$important = $arr[1];
			
			$arrswtchid = explode('=swtchid=', $_color);
			$arrswt_chid = $arrswtchid[1];
			
			

$swatchHelper=$objectManager->get("Magento\Swatches\Helper\Media");
$swatchCollection = $objectManager->create('Magento\Swatches\Model\ResourceModel\Swatch\Collection');
// brand logo is my Visual Swatch attribute 
$optionIdvalue=$product->getColor(); 
$swatchCollection->addFieldtoFilter('option_id',$arrswtchid[1]);
$item=$swatchCollection->getFirstItem();
//echo $swatchHelper->getSwatchAttributeImage('swatch_thumb', $item->getValue());
//echo $swatchHelper->getSwatchAttributeImage('swatch_image', $item->getValue());


			/*$swatch = $objectManager->create('Magento\Swatches\Model\Swatch')->load($arrswtchid[1]);
			echo 'kkk:--:-'.$imageName=$swatch->getData('value');			
			if(!empty($imageName)){
			$imagePath=$objectManager->create('Magento\Swatches\Helper\Media')->getSwatchMediaUrl().$imageName;
			echo 'hii:-'.$imagePath;
			}*/


			
  /*echo '<pre>';
  var_dump($_color);
    echo '</pre>';
			 <div class="swatch-option color" option-type="1" option-id="#" option-label="<?php echo $arr[0]; ?>" option-tooltip-thumb="" option-tooltip-value="#<?php echo $arr[0]; ?>" "="" style="background: #<?php echo $arr[1]; ?> no-repeat center; background-size: initial;"></div>*/
	?>
             
             <div class="swatch-option image" option-type="2" option-id="13" option-label="<?php echo $arr[0]; ?>" option-tooltip-thumb="<?php echo $swatchHelper->getSwatchAttributeImage('swatch_thumb', $item->getValue()); ?>" option-tooltip-value="<?php echo $swatchHelper->getSwatchAttributeImage('swatch_image', $item->getValue()); ?>" "="" style="background: url(<?php echo $swatchHelper->getSwatchAttributeImage('swatch_image', $item->getValue()); ?>) no-repeat center; background-size: initial;"></div>
             
			<?php }	 ?>
              </div>
               </div>
             </div>
             <?php
			}
			/*
			get custom option
			$pro_duct = $objectManager->create('Magento\Catalog\Model\Product')->load($product->getData('entity_id'));
			
			if(!empty($pro_duct->getOptions()))
				{
				foreach($pro_duct->getOptions() as $o) {
					foreach ($o->getValues() as $value) {
						$data=$value->getData();
						$id=$data['option_type_id'];
						$price=$data['price'];
						echo '<br>aaa'.$title=$data['title'];
					}
				}
				}*/
/*			if($product->getTypeId() == 'grouped' ){
			
			}			*/
			?>
            <a class="weltpixel_quickview_button_v2 weltpixel-quickview" data-quickview-url="<?php echo $block->getUrl();?>weltpixel_quickview/catalog_product/view/id/<?php echo $product->getId(); ?>/" href="javascript:void(0);"><span><?php echo __('Quick View') ?></span></a>
            </div>
          </div>
        </li>
     
     
<?php 


			}

		}
	$i++;
	}
	?>
    
     </ol>
    </div>
    
  </div>
  
  	<div class="sponsor-media-count-6881703303  sponsor-media-count">
  	</div>
  	<div class="nr-pn-btn-area"><span id="prev-6881703303" class="prev">&nbsp;</span>
	<span id="next-6881703303" class="next">&nbsp;</span>
        </div>
        
        
</div>  
	</div>
    
	

    
    

    
    <?php else: ?>
    <?php /*?> Default View <?php */?>
        <?php echo $block->getProductListHtml() ?>
    <?php endif; ?>
<?php endif; ?>
<?php 
}

?>

<script type="text/javascript">
require(['jquery', 'jquery/ui'], function($){
$( document ).ajaxComplete(function() {  

	$('div.swatch-attribute.color').each(function(){
		$(this).parent().find('div.available_color').html('Available in '+$('div.swatch-option', $(this)).length+' Colors');
		$(this).parent().parent().find('div.available_color').html('Available in '+$('div.swatch-option', $(this)).length+' Colors');
	});

});
});

</script> 