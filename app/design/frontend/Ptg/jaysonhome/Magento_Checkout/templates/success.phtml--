<?php
/**
 * Copyright Â© 2013-2017 Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

// @codingStandardsIgnoreFile

?>

<?php /** @var $block \Magento\Checkout\Block\Onepage\Success */ ?>
<div class="checkout-success">
<h1 class="succes-ttl"><?php echo __('Thank You for your Order!') ?> </h1>
    <?php if ($block->getOrderId()):?>
        <?php if ($block->getCanViewOrder()) :?>
			
            <p class="ord-no"><?php echo __('Order No: %1.', sprintf('<a href="%s" class="order-number"><strong>%s</strong></a>', $block->escapeHtml($block->getViewOrderUrl()), $block->escapeHtml($block->getOrderId()))) ?></p>
        <?php  else :?>
            <p class="ord-no"><?php echo __('Order No. <span>%1</span>.', $block->escapeHtml($block->getOrderId())) ?></p>
        <?php endif;?>
            <p class="ord-desc"><?php /* @escapeNotVerified */ echo __('We\'ll email you an order confirmation with details and tracking information. Click ') ?><a href="javascript:window.print()">here</a><?php echo __(' to print a copy.') ?></p>
    <?php endif;?>

    <?php echo $block->getAdditionalInfoHtml() ?>

    
    
<?php     

$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$order = $objectManager->create('Magento\Sales\Model\Order')->loadByIncrementId($block->getOrderId());
//$objectManager->create('Magento\Sales\Model\Order')->load($block->getOrderId());

/*$orderNo = $block->getOrderId();

if( $_SERVER['SERVER_ADDR']== '192.168.1.151'){
$detailsFile = fopen($_SERVER['DOCUMENT_ROOT'] ."/jaysonhome/custom-script/order-txt/".$orderNo.".txt","w") or die("error"); 
}else{
$detailsFile = fopen($_SERVER['DOCUMENT_ROOT'] ."/custom-script/order-txt".$orderNo.".txt","w") or die("error"); 
}*/


$items = $order->getAllItems();
$image = 'category_page_grid';

foreach($items as $i):
   $_product= $objectManager->create('Magento\Catalog\Model\Product')->load($i->getProductId());
   
$_imagehelper = $this->helper('Magento\Catalog\Helper\Image');
$productImage = $_imagehelper->init($_product, $image)->constrainOnly(FALSE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize(250)->getUrl();
	 
?>
<div class="pro-data">
	<div class="pro-dataleft">
		<img src="<?php echo $productImage; ?>" />
	</div>
	<div class="pro-dataright">	
		<p class="prod-name-scs"><?php echo $_product->getName(); ?></p>
		<ul class="social-share">
			<li class="sucsmp-txt">Share:</li>
			<li class="suc-twitter"><a href="javascript:window.open('//twitter.com/home/?status=<?php echo urlencode($_product->getName() . ' (' . $_product->getProductUrl() . ')'); ?>', 'twitter', 'width=640,height=480,left=0,top=0,location=no,status=yes,scrollbars=yes,resizable=yes');" title="<?php echo __('Tweet') ?>">Twitter</a></li>
    
    <li class="suc-pin"><a href="javascript:window.open('//pinterest.com/pin/create/button/?url=<?php echo urlencode($_product->getProductUrl()); ?>&media=<?php echo urlencode($productImage); ?>&description=<?php echo urlencode($_product->getName()); ?>', 'pinterest', 'width=640,height=480,left=0,top=0,location=no,status=yes,scrollbars=yes,resizable=yes');" title="<?php echo __('Pin it') ?>">Pinterest</a></li>
    
    <li class="suc-fcbk"><a href="javascript:window.open('//www.facebook.com/sharer/sharer.php?u=<?php echo urlencode($_product->getProductUrl()); ?>&t=<?php echo urlencode($_product->getName()); ?>', 'facebook', 'width=640,height=480,left=0,top=0,location=no,status=yes,scrollbars=yes,resizable=yes');" title="<?php echo __('Share on Facebook') ?>">Facebook</a></li>
	</ul>
	</div>
	        
    
    
</div>
<?php 

endforeach;

?>

<div class="actions-toolbar">
        <div class="primary">
            <a class="action primary continue" href="<?php /* @escapeNotVerified */ echo $block->getUrl() ?>"><span><?php /* @escapeNotVerified */ echo __('Continue Shopping') ?></span></a>
        </div>
    </div>
    
<?php echo $block->getLayout()->createBlock('Magento\Cms\Block\Block')->setBlockId('need-help-area')->toHtml();?> 
</div>
<?php 
$chk_1 = '';
if(isset($_COOKIE['chk_1'])){
$chk_1 = $_COOKIE['chk_1'];
}
/*echo '<pre>';
var_dump($order->debug());
echo '</pre>';
///var_dump($chk_1);

/*
echo '<br>encode === '.$encode = base64_encode($chk_1);*/
$decode = base64_decode($chk_1);



$url = \Magento\Framework\App\ObjectManager::getInstance();
$storeManager = $url->get('\Magento\Store\Model\StoreManagerInterface');


$websiteId = $storeManager->getWebsite()->getWebsiteId();

$CustomerModel = $objectManager->create('Magento\Customer\Model\Customer');
$CustomerModel->setWebsiteId($websiteId);
$CustomerModel->loadByEmail($order->getCustomerEmail());

/*echo '<pre>';
var_dump($CustomerModel->getData());
echo '</pre>';*/
$userId = $CustomerModel->getId();
	
	$billingAddress = $order->getBillingAddress();
	$_fname = $billingAddress->getData('firstname');
	$_lname = $billingAddress->getData('lastname');
	$log_out = 0;
		/*echo '<br>$userId==='.$userId;
		echo "<br>getCustomerIsGuest===".$order->getCustomerIsGuest(); 
		echo "<br>getCustomerGroupId===".$order->getCustomerGroupId(); */
if(!$userId){
	
	
	
	$customerFactory = $objectManager->get('\Magento\Customer\Model\CustomerFactory');
	$websiteId = $storeManager->getWebsite()->getWebsiteId();
	$store = $storeManager->getStore();
	$storeId = $store->getStoreId();

	$customer = $customerFactory->create();
	$customer->setWebsiteId($websiteId); 
	$customer->setEmail($order->getCustomerEmail()); 
	$customer->setFirstname($_fname); 
	$customer->setLastname($_lname);
	if($chk_1!=""){
	$customer->setPassword($decode); 
	
	$customer->save();
	}
	
	if($order->getCustomerIsGuest()==1 && $order->getCustomerGroupId()==0 && $chk_1!=""){
		
		
		$resource = $objectManager->get('Magento\Framework\App\ResourceConnection');
			$connection = $resource->getConnection();
			$tbt_customer_entity = $resource->getTableName('customer_entity');
			$tbt_sales_order = $resource->getTableName('sales_order');
			$connection->query("UPDATE `".$tbt_customer_entity."` SET `password_hash` = CONCAT(SHA2('xxxxxxxx".$decode."', 256), ':xxxxxxxx:1') WHERE `email` = '".$order->getCustomerEmail()."';");
			
			$connection->query("UPDATE `".$tbt_sales_order."` SET `customer_firstname` = '".$_fname."', `customer_lastname` = '".$_lname."', `customer_group_id` = '1' WHERE `sales_order`.`entity_id` = ".$order->getEntityId().";");	
		
		$CustomerModel->setWebsiteId($websiteId);
		$CustomerModel->loadByEmail($order->getCustomerEmail());	
		$customerSession = $objectManager->create('Magento\Customer\Model\Session');
		$customerSession->setCustomerAsLoggedIn($CustomerModel);		
		$log_out = 1;
		}
	}else{
	if($chk_1!=""){
		$resource = $objectManager->get('Magento\Framework\App\ResourceConnection');
		$connection = $resource->getConnection();
		$tbt_customer_entity = $resource->getTableName('customer_entity');
		$tbt_sales_order = $resource->getTableName('sales_order');
		$connection->query("UPDATE `".$tbt_customer_entity."` SET `password_hash` = CONCAT(SHA2('xxxxxxxx".$decode."', 256), ':xxxxxxxx:1') WHERE `email` = '".$order->getCustomerEmail()."';");
		
		$connection->query("UPDATE `".$tbt_sales_order."` SET `customer_firstname` = '".$_fname."', `customer_lastname` = '".$_lname."', `customer_group_id` = '1' WHERE `sales_order`.`entity_id` = ".$order->getEntityId().";");	
		
	$customerSession = $objectManager->create('Magento\Customer\Model\Session');
	$customerSession->setCustomerAsLoggedIn($CustomerModel);		
	$log_out = 1;
	}
	
	}
?>

<script type="text/javascript">
require(['jquery', 'jquery/ui'], function($){
	var log_out = "<?php echo $log_out; ?>";
	var base_url = "<?php echo $storeManager->getStore()->getBaseUrl(); ?>";
	if(log_out==1){
		jQuery('li.authorization-link').html("<a href='"+base_url+"customer/account/logout/'>Sign Out</a>");

	}

});
</script>